<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SDJ Online Support</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background: linear-gradient(to bottom right, #f97316, #facc15); color:white; }
  .fade-out { opacity:0; transition: opacity 1s ease; }
  .loader { border:4px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; width:48px; height:48px; animation:spin 1s linear infinite; margin:auto; }
  @keyframes spin { to{ transform: rotate(360deg); } }
  .pulse-glow { animation:pulse 2s infinite; box-shadow:0 0 20px rgba(255,0,0,0.6); }
  @keyframes pulse { 0%,100%{box-shadow:0 0 15px rgba(255,0,0,0.6);} 50%{box-shadow:0 0 30px rgba(255,0,0,0.9);} }

  /* Chat bubble styles */
  .chat-bubble { padding:8px 12px; margin:4px 0; border-radius:16px; display:inline-block; max-width:75%; position:relative; }
  .chat-user { background-color:#f97316; color:white; margin-left:auto; border-bottom-right-radius:0; }
  .chat-bot { background-color:#3b82f6; color:white; margin-right:auto; border-bottom-left-radius:0; }
  .chat-staff { background-color:#16a34a; color:white; margin-right:auto; border-bottom-left-radius:0; }
  .chat-time { font-size:0.7rem; opacity:0.7; display:block; margin-top:2px; text-align:right; }
  #chatWindow, #staffChatWindow { display:flex; flex-direction:column; }
</style>
</head>
<body class="min-h-screen flex flex-col">

<header class="text-center py-8">
  <h1 class="text-4xl md:text-5xl font-bold drop-shadow">SDJ Online Support</h1>
  <p class="mt-2 opacity-80">Your trusted help center</p>
</header>

<main class="flex-grow flex items-center justify-center px-4">
  <div id="card" class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-xl p-8 w-full max-w-3xl text-white">
    <!-- Main content rendered dynamically -->
  </div>
</main>

<footer class="text-center py-4 text-sm bg-black/20">
  <span>Powered by <strong>Dev Studios</strong> • Copyright 2025 Dev Studios</span>
</footer>

<script>
const AUTO_WIPE_MS=24*60*60*1000;
const SUPPORT_PASSWORD="SDJSupport10";
const STAFF_PASSWORD="SDJStaff20";

/* ---------- Auto wipe ---------- */
(function autoWipeCheck(){
  const lastSave=parseInt(localStorage.getItem("lastSaveTime")||"0",10);
  if(!lastSave || Date.now()-lastSave>AUTO_WIPE_MS){ localStorage.clear(); localStorage.setItem("lastSaveTime",Date.now().toString()); }
})();

/* ---------- Helpers ---------- */
function getMessages(){ return JSON.parse(localStorage.getItem("chatMessages")||"[]"); }
function saveMessages(msgs){ localStorage.setItem("chatMessages",JSON.stringify(msgs)); localStorage.setItem("lastSaveTime",Date.now().toString()); }
function getMeta(){ return JSON.parse(localStorage.getItem("chatMeta")||"{}"); }
function saveMeta(meta){ localStorage.setItem("chatMeta",JSON.stringify(meta)); localStorage.setItem("lastSaveTime",Date.now().toString()); }
function pushMessage(userId,sender,text){ const msgs=getMessages(); const time=new Date().toLocaleString(); msgs.push({userId,sender,text,time}); saveMessages(msgs); return {userId,sender,text,time}; }
function escapeHtml(s){ if(!s && s!==0)return""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'", "&#039;"); }

/* ---------- Main ---------- */
const card=document.getElementById("card");

function renderMain(){
  card.innerHTML=`
<h2 class="text-2xl font-semibold mb-6 text-center">Welcome to SDJ Support Portal</h2>
<div id="mainButtons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <button id="supportLoginBtn" class="bg-white text-orange-600 py-3 rounded-xl font-semibold hover:bg-orange-100 transition">Support Login</button>
  <button id="onlineSupportBtn" class="bg-orange-700 py-3 rounded-xl font-semibold hover:bg-orange-800 transition">Online Support</button>
  <button id="staffLoginBtn" class="bg-gray-800/60 py-3 rounded-xl font-semibold hover:bg-gray-700 transition">Staff Login</button>
</div>
<div class="mt-6 text-sm opacity-80">
<p>Footer: Powered by <span class="font-semibold">Dev Studios</span> • © 2025 Dev Studios</p>
</div>`;
  document.getElementById("supportLoginBtn").onclick=openSupportLogin;
  document.getElementById("onlineSupportBtn").onclick=openUserChat;
  document.getElementById("staffLoginBtn").onclick=openStaffLogin;
}

/* ---------- SUPPORT LOGIN ---------- */
function openSupportLogin(){
  card.innerHTML=`
<h2 class="text-2xl font-semibold mb-4 text-center">Support Login</h2>
<input id="loginUser" placeholder="Enter Username" class="w-full mb-3 p-3 rounded text-black" />
<input id="loginPass" type="password" placeholder="Enter Password" class="w-full mb-3 p-3 rounded text-black" />
<div class="grid grid-cols-2 gap-3">
  <button id="loginConfirm" class="bg-white text-orange-600 py-2 rounded font-semibold">Login</button>
  <button id="loginCancel" class="bg-gray-700 py-2 rounded font-semibold">Cancel</button>
</div>`;
  document.getElementById("loginCancel").onclick=renderMain;
  document.getElementById("loginConfirm").onclick=()=>{
    const u=document.getElementById("loginUser").value.trim()||"User";
    const p=document.getElementById("loginPass").value;
    if(p===SUPPORT_PASSWORD){
      card.innerHTML=`<div class="flex flex-col items-center"><div class="loader mb-4"></div><p class="text-lg font-semibold">Logging in...</p></div>`;
      setTimeout(()=>{
        card.innerHTML=`<h2 class="text-2xl font-semibold mb-2">Successfully Logged in</h2><p>Welcome ${escapeHtml(u)}!</p>`;
        setTimeout(()=>{
          card.classList.add("fade-out");
          setTimeout(()=>{
            card.innerHTML=`
<h2 class="text-2xl font-semibold mb-4">System Control</h2>
<p class="mb-4">You can reset the system to clear all saved chat data and restart.</p>
<button id="resetSystemBtn" class="bg-red-600 pulse-glow py-3 rounded-xl font-semibold w-full mb-3">Reset System</button>
<button id="backBtn" class="bg-white text-orange-600 py-3 rounded-xl font-semibold w-full">Back to Main</button>`;
            card.classList.remove("fade-out");
            document.getElementById("resetSystemBtn").onclick=()=>{ if(confirm("Reset system?")){ localStorage.clear(); location.reload(); } };
            document.getElementById("backBtn").onclick=renderMain;
          },800);
        },5000);
      },1800);
    }else{ alert("Incorrect password."); }
  };
}

/* ---------- USER CHAT ---------- */
function openUserChat(){
  let uniqueUser=localStorage.getItem("uniqueUser");
  if(!uniqueUser){ uniqueUser=`Player${Math.floor(10000+Math.random()*90000)}`; localStorage.setItem("uniqueUser",uniqueUser); }
  card.innerHTML=`
<div class="flex items-center justify-between mb-3">
  <div>
    <h3 class="text-lg font-semibold">Online Support Chat</h3>
    <div class="text-sm opacity-80">You are <strong id="youTag">${escapeHtml(uniqueUser)}</strong></div>
  </div>
  <div class="flex gap-2 items-center">
    <button id="resetSystemSmall" class="bg-red-600 px-3 py-1 rounded font-semibold">Reset System</button>
    <button id="backToMain" class="bg-white text-orange-600 px-3 py-1 rounded font-semibold">Back</button>
  </div>
</div>
<div id="chatWindow" class="bg-white/10 text-white rounded-lg p-4 h-72 overflow-y-auto mb-3"></div>
<div class="flex gap-2">
  <input id="userInput" class="flex-grow p-2 rounded text-black" placeholder="Type your message..." />
  <button id="sendBtn" class="bg-orange-700 px-4 py-2 rounded font-semibold hover:bg-orange-800">Send</button>
</div>`;
  document.getElementById("backToMain").onclick=renderMain;
  document.getElementById("resetSystemSmall").onclick=()=>{ if(confirm("Reset system?")){ localStorage.clear(); location.reload(); } };

  const chatWindow=document.getElementById("chatWindow");
  const input=document.getElementById("userInput");
  const sendBtn=document.getElementById("sendBtn");

  function renderChat(){
    const msgs=getMessages().filter(m=>m.userId===uniqueUser);
    chatWindow.innerHTML="";
    if(msgs.length===0){ chatWindow.innerHTML="<div class='text-center opacity-80'>No messages yet — say hi!</div>"; return; }
    msgs.forEach(m=>{
      let cls="chat-user";
      if(m.sender==="SDJ Automations") cls="chat-bot";
      const staffSessions=JSON.parse(localStorage.getItem("staffSessions")||"[]");
      if(staffSessions.includes(m.sender)) cls="chat-staff";
      const bubble=document.createElement("div");
      bubble.className=`chat-bubble ${cls}`;
      bubble.innerHTML=`<span>${escapeHtml(m.text)}</span><span class="chat-time">${m.time}</span>`;
      chatWindow.appendChild(bubble);
    });
    chatWindow.scrollTop=chatWindow.scrollHeight;
  }

  renderChat();

  sendBtn.onclick=sendUserMessage;
  input.addEventListener("keypress",e=>{ if(e.key==="Enter") sendUserMessage(); });

  function sendUserMessage(){
    const text=input.value.trim(); if(!text) return;
    pushMessage(uniqueUser,uniqueUser,text); input.value="";
    const msgs=getMessages().filter(m=>m.userId===uniqueUser);
    const userCount=msgs.filter(m=>m.sender===uniqueUser).length;
    setTimeout(()=>{
      if(userCount===1){
        pushMessage(uniqueUser,"SDJ Automations","Greetings! Welcome to SDJ Online Support Portal, I am SDJ Automations. To make it easier for our staff members to know who you are please state your Roblox username, and your Discord username if you have Discord.");
      }else if(userCount===2){
        pushMessage(uniqueUser,"SDJ Automations","Thank you for understanding. Please note our staff members are usually busy, so please cope with us! A staff member will be with you soon.");
      }
      renderChat();
    },700);
    renderChat();
  }
}

/* ---------- STAFF LOGIN ---------- */
function openStaffLogin(){
  card.innerHTML=`
<h2 class="text-2xl font-semibold mb-4 text-center">Staff Login</h2>
<input id="staffName" placeholder="Enter your staff display name" class="w-full mb-3 p-3 rounded text-black" />
<input id="staffPass" type="password" placeholder="Staff Password" class="w-full mb-3 p-3 rounded text-black" />
<div class="grid grid-cols-2 gap-3">
  <button id="staffConfirm" class="bg-white text-orange-600 py-2 rounded font-semibold">Login</button>
  <button id="staffCancel" class="bg-gray-700 py-2 rounded font-semibold">Cancel</button>
</div>`;
  document.getElementById("staffCancel").onclick=renderMain;
  document.getElementById("staffConfirm").onclick=()=>{
    const name=document.getElementById("staffName").value.trim();
    const pass=document.getElementById("staffPass").value;
    if(!name){ alert("Enter a display name."); return; }
    if(pass!==STAFF_PASSWORD){ alert("Incorrect staff password."); return; }
    const sessions=JSON.parse(localStorage.getItem("staffSessions")||"[]");
    if(!sessions.includes(name)){ sessions.push(name); localStorage.setItem("staffSessions",JSON.stringify(sessions)); }
    openStaffPanelMulti(name);
  };
}

/* ---------- STAFF PANEL MULTI-USER ---------- */
function openStaffPanelMulti(staffName){
  card.innerHTML=`
<div class="flex h-96 bg-white/10 rounded-xl overflow-hidden text-black">
  <div class="w-1/3 bg-white/20 p-2 flex flex-col">
    <h3 class="font-semibold mb-2">Users</h3>
    <div id="userList" class="flex-grow overflow-y-auto"></div>
    <button id="resetSystemStaff" class="bg-red-600 mt-2 py-1 rounded font-semibold">Reset System</button>
  </div>
  <div class="w-2/3 p-2 flex flex-col">
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-semibold" id="chatTitle">Select a user</h3>
      <div class="flex gap-2">
        <button id="markResolvedBtn" class="bg-green-600 px-2 py-1 rounded font-semibold">Mark Resolved</button>
        <button id="unresolveBtn" class="bg-gray-700 px-2 py-1 rounded font-semibold">Unresolve</button>
        <button id="logoutStaff" class="bg-white text-orange-600 px-2 py-1 rounded font-semibold">Logout</button>
      </div>
    </div>
    <div id="staffChatWindow" class="flex-grow bg-white/20 rounded-lg p-2 overflow-y-auto mb-2"></div>
    <div class="flex gap-2">
      <input id="staffReplyInput" class="flex-grow p-2 rounded" placeholder="Message as staff..." />
      <button id="staffSendBtn" class="bg-white text-orange-600 px-4 py-2 rounded font-semibold hover:bg-orange-100">Send</button>
    </div>
  </div>
</div>`;

  const staffInput=document.getElementById("staffReplyInput");
  const staffSendBtn=document.getElementById("staffSendBtn");
  const staffChatWindow=document.getElementById("staffChatWindow");
  const chatTitle=document.getElementById("chatTitle");
  const userListDiv=document.getElementById("userList");
  const markResolvedBtn=document.getElementById("markResolvedBtn");
  const unresolveBtn=document.getElementById("unresolveBtn");
  let selectedUser=null;

  document.getElementById("resetSystemStaff").onclick=()=>{ if(confirm("Reset system?")){ localStorage.clear(); location.reload(); } };
  document.getElementById("logoutStaff").onclick=renderMain;

  function getAllUsers(){ const msgs=getMessages(); const users={}; msgs.forEach(m=>{ if(m.userId) users[m.userId]=m; }); return Object.keys(users); }

  function renderUserList(){
    const users=getAllUsers(); userListDiv.innerHTML="";
    if(users.length===0){ userListDiv.innerHTML="<div class='text-sm opacity-70'>No active users.</div>"; return; }
    users.forEach(uid=>{
      const msgs=getMessages().filter(m=>m.userId===uid);
      const lastMsg=msgs[msgs.length-1];
      const meta=getMeta()[uid]||{resolved:false};
      const badge=meta.resolved ? "✅ " : "";
      const el=document.createElement("div");
      el.className="p-1 mb-1 bg-white/10 rounded cursor-pointer hover:bg-white/20";
      el.innerHTML=`<strong>${badge}${uid}</strong><div class="text-xs opacity-70 truncate">${lastMsg?.text||""}</div>`;
      el.onclick=()=>{ selectedUser=uid; chatTitle.textContent=uid; renderChatWindow(); };
      userListDiv.appendChild(el);
    });
  }

  function renderChatWindow(){
    if(!selectedUser) return;
    const msgs=getMessages().filter(m=>m.userId===selectedUser);
    staffChatWindow.innerHTML="";
    if(msgs.length===0){ staffChatWindow.innerHTML="<div class='text-sm opacity-70'>No messages yet.</div>"; return; }
    const staffSessions=JSON.parse(localStorage.getItem("staffSessions")||"[]");
    msgs.forEach(m=>{
      let cls="chat-user";
      if(m.sender==="SDJ Automations") cls="chat-bot";
      if(staffSessions.includes(m.sender)) cls="chat-staff";
      const bubble=document.createElement("div");
      bubble.className=`chat-bubble ${cls}`;
      bubble.innerHTML=`<span>${escapeHtml(m.text)}</span><span class="chat-time">${m.time}</span>`;
      staffChatWindow.appendChild(bubble);
    });
    staffChatWindow.scrollTop=staffChatWindow.scrollHeight;
  }

  markResolvedBtn.onclick=()=>{
    if(!selectedUser) return alert("Select a user first.");
    const meta=getMeta();
    meta[selectedUser]={resolved:true,resolvedBy:staffName,resolvedAt:Date.now()};
    saveMeta(meta); renderUserList(); renderChatWindow(); alert("Chat marked resolved.");
  };

  unresolveBtn.onclick=()=>{
    if(!selectedUser) return alert("Select a user first.");
    const meta=getMeta();
    meta[selectedUser]={resolved:false,resolvedBy:null,resolvedAt:null};
    saveMeta(meta); renderUserList(); renderChatWindow(); alert("Chat unmarked.");
  };

  staffSendBtn.onclick=()=>{
    if(!selectedUser) return alert("Select a user first.");
    const text=staffInput.value.trim(); if(!text) return;
    const msgs=getMessages(); 
    msgs.push({userId:selectedUser,sender:staffName,text,time:new Date().toLocaleString()});
    saveMessages(msgs); staffInput.value=""; renderChatWindow(); renderUserList();
  };
  staffInput.addEventListener("keypress",e=>{ if(e.key==="Enter") staffSendBtn.onclick(); });

  renderUserList();
}

/* ---------- Initialize ---------- */
renderMain();
</script>

</body>
</html>
